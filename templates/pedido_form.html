{% extends "base.html" %}
{% block title %}{{ 'Nuevo pedido' if modo == 'nuevo' else 'Editar pedido' }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4">
    <div>
      <h2 class="h3 mb-1">{{ 'Registrar pedido' if modo == 'nuevo' else 'Actualizar pedido' }}</h2>
      <p class="text-muted mb-0">Completa la informaci√≥n y revisa el resumen de men√∫s seleccionados.</p>
    </div>
  </div>

  {% set tiene_menus_seleccionados = menus_seleccionados and (menus_seleccionados | length > 0) %}

  <form method="POST" class="pedido-form">
    <input type="hidden" id="iva-rate" value="{{ iva_rate }}">
    <input type="hidden" name="id_restaurante" id="id_restaurante" value="{% if pedido %}{{ pedido.idRestaurante }}{% elif tiene_menus_seleccionados %}{{ menus_seleccionados[0].idRestaurante }}{% endif %}">

    <div class="form-layout {% if modo == 'nuevo' or tiene_menus_seleccionados %}with-sidebar{% endif %}">
      <div class="form-main">
        <!-- Bloque: Datos del cliente -->
        <div class="section-card mb-4">
          <h5 class="section-title">Datos del cliente</h5>
          <div class="row g-4">
            <div class="col-md-6">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Cliente <span class="text-danger">*</span>
              </label>
              <input
                list="clientes"
                name="nombre_cliente"
                placeholder="Seleccione o escriba un cliente"
                class="form-control form-control-lg rounded-3 shadow-sm"
                value="{% if pedido %}{{ pedido.nombre_cliente }}{% endif %}"
                required
              >
              <datalist id="clientes">
                {% for c in clientes %}
                <option value="{{ c.NombreCompleto }}" data-id="{{ c.id_cliente }}">
                {% endfor %}
              </datalist>
              <input type="hidden" name="id_cliente" id="id_cliente_hidden" value="{% if pedido %}{{ pedido.id_cliente }}{% endif %}">
            </div>

            <div class="col-md-6">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Empleado que registra <span class="text-danger">*</span>
              </label>
              <select name="id_empleado" class="form-select form-select-lg rounded-3 shadow-sm" required>
                <option value="">Seleccione...</option>
                {% for e in empleados %}
                <option value="{{ e.id_empleado }}" {% if pedido and pedido.idEmpleado == e.id_empleado %}selected{% endif %}>
                  {{ e.NombreCompleto }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <!-- Bloque: Configuraci√≥n del pedido -->
        <div class="section-card mb-4">
          <h5 class="section-title">Configuraci√≥n del pedido</h5>
          <div class="row g-4">
            <div class="col-lg-4 col-md-6">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Estado del pedido <span class="text-danger">*</span>
              </label>
              {% if modo == 'nuevo' %}
                {% set estado_pendiente = estados | selectattr('descripcion', 'equalto', 'Pendiente') | list | first %}
                <input type="hidden" name="id_estado_pedido" value="{{ estado_pendiente.id_estado_pedido if estado_pendiente else '' }}">
                <input type="text" class="form-control form-control-lg rounded-3 shadow-sm" value="Pendiente" readonly>
              {% else %}
                <select id="estado-select" name="id_estado_pedido" class="form-select form-select-lg rounded-3 shadow-sm" required>
                  {% for e in estados %}
                  <option value="{{ e.id_estado_pedido }}"
                          class="
                              {% if e.descripcion == 'Pendiente' %}estado-pendiente
                              {% elif e.descripcion == 'En preparaci√≥n' %}estado-preparacion
                              {% elif e.descripcion == 'En camino' %}estado-camino
                              {% elif e.descripcion == 'Entregado' %}estado-entregado
                              {% elif e.descripcion == 'Cancelado' %}estado-cancelado
                              {% endif %}
                          "
                          {% if pedido and pedido.idEstado_pedido == e.id_estado_pedido %}selected{% endif %}>
                    {{ e.descripcion }}
                  </option>
                  {% endfor %}
                </select>
              {% endif %}
            </div>

            <div class="col-lg-4 col-md-6">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Tipo de pedido <span class="text-danger">*</span>
              </label>
              <select name="id_tipo_pedido" id="tipo_pedido" class="form-select form-select-lg rounded-3 shadow-sm" required>
                <option value="">Seleccione...</option>
                {% for t in tipos %}
                <option value="{{ t.id_tipo_pedido }}" {% if pedido and pedido.id_tipo_pedido == t.id_tipo_pedido %}selected{% endif %}>
                  {{ t.descripcion }}
                </option>
                {% endfor %}
              </select>
            </div>

            {% if modo != 'nuevo' %}
            <div class="col-lg-4 col-md-6">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Men√∫ <span class="text-danger">*</span>
              </label>
              <select name="id_menu" class="form-select form-select-lg rounded-3 shadow-sm" required>
                <option value="">Seleccione...</option>
                {% for m in menus %}
                <option value="{{ m.idMenu }}"
                        data-precio="{{ m.Precio }}"
                        data-restaurante="{{ m.idRestaurante }}"
                        {% if pedido and pedido.idMenu == m.idMenu %}selected{% endif %}>
                  {{ m.Descripcion }} - ${{ "%.2f"|format(m.Precio) }}
                </option>
                {% endfor %}
              </select>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Bloque: Log√≠stica y entrega -->
        <div class="section-card mb-4">
          <h5 class="section-title">Log√≠stica y entrega</h5>
          <div class="row g-4">
            <div class="col-lg-4 col-md-6">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Costo de pedido <span class="text-danger">*</span>
              </label>
              <select name="id_costo_pedido" id="costo_pedido" class="form-select form-select-lg rounded-3 shadow-sm" required>
                <option value="">Seleccione...</option>
                {% for c in costos_pedido %}
                <option value="{{ c.id_costo_pedido }}"
                        data-costo="{% if 'est√°ndar' in c.descripcion|lower %}1.50{% elif 'premium' in c.descripcion|lower %}2.00{% elif 'empresarial' in c.descripcion|lower %}1.00{% elif 'combo' in c.descripcion|lower %}1.75{% elif 'especial' in c.descripcion|lower %}2.50{% else %}1.50{% endif %}"
                        {% if pedido and pedido.id_costo_pedido == c.id_costo_pedido %}selected{% endif %}>
                  {{ c.descripcion }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-lg-4 col-md-6" data-field="costo_entrega">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Costo de entrega
              </label>
              <select name="id_costo_entrega" class="form-select form-select-lg rounded-3 shadow-sm">
                <option value="">Seleccione...</option>
                {% for ce in costos_entrega %}
                <option value="{{ ce.id_costo_entrega }}" {% if pedido and pedido.id_costo_entrega == ce.id_costo_entrega %}selected{% endif %}>
                  {{ ce.descripcion }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-lg-4 col-md-6" data-field="referencia">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Referencia (direcci√≥n)
              </label>
              <select name="id_referencia" class="form-select form-select-lg rounded-3 shadow-sm">
                <option value="">(Opcional)</option>
                {% for r in referencias %}
                <option value="{{ r.idReferencia }}" {% if pedido and pedido.idReferencia == r.idReferencia %}selected{% endif %}>
                  {{ r.descripcion }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-lg-4 col-md-6">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                M√©todo de pago <span class="text-danger">*</span>
              </label>
              <select name="id_metodo_pago" class="form-select form-select-lg rounded-3 shadow-sm" required>
                <option value="">Seleccione...</option>
                {% for m in metodos_pago %}
                <option value="{{ m.idMetodo_de_pago }}" {% if pedido and pedido.idMetodo_de_pago == m.idMetodo_de_pago %}selected{% endif %}>
                  {{ m.descripcion }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-lg-4 col-md-6" data-field="repartidor">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Repartidor <span class="text-danger" id="repartidor_required">*</span>
              </label>
              <select name="id_repartidor" id="repartidor" class="form-select form-select-lg rounded-3 shadow-sm" required>
                <option value="">Seleccione...</option>
                {% for r in repartidores %}
                <option value="{{ r.idRepartidor }}" {% if pedido and pedido.idRepartidor == r.idRepartidor %}selected{% endif %}>
                  {{ r.NombreCompleto }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <!-- Bloque: Fechas -->
        <div class="section-card mb-4">
          <h5 class="section-title">Fechas</h5>
          <div class="row g-4">
            <div class="col-lg-4 col-md-6">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Fecha del pedido <span class="text-danger">*</span>
              </label>
              <input type="date" name="fecha_pedido" class="form-control form-control-lg rounded-3 shadow-sm" value="{% if pedido and pedido.Fecha_pedido %}{{ pedido.Fecha_pedido[:10] }}{% endif %}" required>
            </div>

            <div class="col-lg-4 col-md-6" data-field="fecha_entrega" {% if not fecha_entrega_value %}style="display: none;"{% endif %}>
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Fecha de entrega <span class="text-danger">*</span>
              </label>
              <input type="date" name="fecha_entrega" class="form-control form-control-lg rounded-3 shadow-sm" value="{{ fecha_entrega_value }}" required>
            </div>

            <div class="col-lg-4 col-md-6" data-field="hora_entrega" {% if not hora_entrega_value %}style="display: none;"{% endif %}>
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                  Hora de entrega <span class="text-danger">*</span>
              </label>
              <input type="time" name="hora_entrega" class="form-control form-control-lg rounded-3 shadow-sm" value="{{ hora_entrega_value }}" required>
            </div>
          </div>
        </div>

        <!-- Bloque: Resumen econ√≥mico -->
        <div class="section-card mb-4">
          <h5 class="section-title">Resumen econ√≥mico</h5>
          <div class="totales-stack">
            <div class="totales-item">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Total pedido (productos) <span class="text-danger">*</span>
              </label>
              <div class="input-group input-group-lg shadow-sm rounded-3">
                <span class="input-group-text bg-light border-0 rounded-start-3">$</span>
                <input type="number" step="0.01" name="total_pedido" id="total_pedido" class="form-control border-0 rounded-end-3" value="{% if pedido and pedido.Total_pedido %}{{ pedido.Total_pedido }}{% endif %}" placeholder="0.00" required>
              </div>
            </div>

            <div class="totales-item">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Costo servicio <span class="text-danger" id="costo_servicio_required">*</span>
              </label>
              <div class="input-group input-group-lg shadow-sm rounded-3">
                <span class="input-group-text bg-light border-0 rounded-start-3">$</span>
                <input type="number" step="0.01" name="costo_servicio" id="costo_servicio" class="form-control border-0 rounded-end-3" value="{% if pedido and pedido.Costo_servicio %}{{ pedido.Costo_servicio }}{% endif %}" placeholder="0.00" required>
              </div>
            </div>

            <div class="totales-item">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                IVA
              </label>
              <div class="input-group input-group-lg shadow-sm rounded-3">
                <span class="input-group-text bg-light border-0 rounded-start-3">$</span>
                <input type="number" step="0.01" name="iva_monto" id="iva_monto" class="form-control border-0 rounded-end-3" value="" placeholder="0.00" readonly>
              </div>
              <small class="text-muted">Se calcula autom√°ticamente.</small>
            </div>

            <div class="totales-item">
              <label class="form-label fw-semibold text-muted mb-2" style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                Total a pagar <span class="text-danger">*</span>
              </label>
              <div class="input-group input-group-lg shadow-sm rounded-3">
                <span class="input-group-text bg-light border-0 rounded-start-3">$</span>
                <input type="number" step="0.01" name="total_pagar" id="total_pagar" class="form-control border-0 rounded-end-3" value="{% if pedido and pedido.Total_pagar %}{{ pedido.Total_pagar }}{% endif %}" placeholder="0.00" required readonly>
              </div>
              <small class="text-muted">Se calcula autom√°ticamente (IVA: $<span id="iva_resumen">0.00</span>)</small>
            </div>
          </div>
        </div>

        <!-- Botones -->
        <div class="d-flex gap-3 pt-4 border-top">
          <button type="submit" class="btn btn-primary btn-lg px-5 rounded-pill shadow-sm">
            üíæ Guardar
          </button>
          <a href="{{ url_for('pedidos_list') }}" class="btn btn-outline-secondary btn-lg px-5 rounded-pill">
            Cancelar
          </a>
        </div>
      </div>

      {% if modo == 'nuevo' or tiene_menus_seleccionados %}
      <aside class="form-sidebar">
        <div class="section-card mb-0">
          <h5 class="section-title">Men√∫s seleccionados</h5>
          {% if tiene_menus_seleccionados %}
          <div class="sidebar-list">
            {% for menu in menus_seleccionados %}
            <div class="sidebar-item">
              <div class="sidebar-item-info">
                <span class="sidebar-item-title">{{ menu.Descripcion }}</span>
                <span class="sidebar-item-restaurant">
                  {% if menu.Restaurante %}
                    {% set nombre_restaurante = menu.Restaurante %}
                    {% if nombre_restaurante.lower().startswith('restaurante ') %}
                      {% set nombre_restaurante = nombre_restaurante[12:] %}
                    {% endif %}
                    Restaurante: {{ nombre_restaurante.strip() }}
                  {% else %}
                    Restaurante: Sin registro
                  {% endif %}
                </span>
              </div>
              <span class="sidebar-item-price">${{ menu.PrecioTexto }}</span>
            </div>
            <input type="hidden" name="selected_menu_ids" value="{{ menu.idMenu }}">
            {% endfor %}
          </div>
          {% else %}
          <div class="sidebar-empty">
            <p class="sidebar-empty-text">Todav√≠a no has seleccionado platos para este pedido.</p>
            <a href="{{ url_for('menus_list') }}" class="select-menus-btn">Seleccionar platos</a>
          </div>
          {% endif %}
        </div>
      </aside>
      {% endif %}
    </div>
  </form>
</div>

<style>
/* Estilos personalizados para el formulario */
.form-select,
.form-control {
  border: 1px solid #e0e0e0;
  transition: all 0.3s ease;
  font-size: 0.95rem;
}

.form-select:focus,
.form-control:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15) !important;
}

.input-group-text {
  font-weight: 600;
  color: #6c757d;
}

.btn {
  transition: all 0.3s ease;
  font-weight: 500;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.15) !important;
}

.btn-primary {
  background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
  border: none;
}

.section-card {
  background-color: #ffffff;
  border: 1px solid #edf2f7;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 6px 20px rgba(13, 27, 62, 0.05);
}

.section-title {
  font-size: 0.75rem;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  color: #6c757d;
  margin-bottom: 1rem;
}

.totales-stack {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.totales-item {
  display: flex;
  flex-direction: column;
}

.form-layout {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.form-layout.with-sidebar {
  display: grid;
  grid-template-columns: minmax(0, 1fr) 320px;
  gap: 1.5rem;
  align-items: start;
}

.form-main {
  min-width: 0;
}

.form-sidebar {
  min-width: 0;
}

.sidebar-list {
  display: flex;
  flex-direction: column;
  gap: 0.85rem;
  max-height: 60vh;
  overflow-y: auto;
  padding-right: 0.25rem;
}

.sidebar-empty {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  align-items: stretch;
  text-align: center;
  padding: 0.75rem 0;
}

.sidebar-empty-text {
  font-size: 0.9rem;
  color: #6c757d;
  margin: 0;
}

.select-menus-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.85rem 1rem;
  border-radius: 999px;
  border: 1px solid #0d6efd;
  color: #0d6efd;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s ease;
  width: 100%;
}

.select-menus-btn:hover {
  background-color: #0d6efd;
  color: #fff;
  box-shadow: 0 6px 18px rgba(13, 110, 253, 0.25);
}

.sidebar-item {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 0.75rem;
  padding: 0.85rem 1rem;
  background-color: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 0.75rem;
}

.sidebar-item-info {
  flex: 1;
  min-width: 0;
}

.sidebar-item-title {
  display: block;
  font-weight: 600;
  color: #212529;
  margin-bottom: 0.25rem;
}

.sidebar-item-restaurant {
  display: block;
  font-size: 0.85rem;
  color: #6c757d;
}

.sidebar-item-price {
  font-weight: 600;
  color: #0d6efd;
  white-space: nowrap;
}

.sidebar-list::-webkit-scrollbar {
  width: 6px;
}

.sidebar-list::-webkit-scrollbar-thumb {
  background-color: rgba(13, 110, 253, 0.35);
  border-radius: 999px;
}

.card {
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: 992px) {
  .form-layout.with-sidebar {
    grid-template-columns: 1fr;
  }

  .form-sidebar {
    width: 100%;
  }
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .col-md-4, .col-md-6 {
    margin-bottom: 1rem;
  }
  .section-card {
    padding: 1.25rem;
  }
}
</style>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const menuSelect = document.querySelector('select[name="id_menu"]');
  const totalPedidoInput = document.getElementById('total_pedido');
  const costoPedidoSelect = document.getElementById('costo_pedido');
  const costoServicioInput = document.getElementById('costo_servicio');
  const costoServicioRequired = document.getElementById('costo_servicio_required');
  const totalPagarInput = document.getElementById('total_pagar');
  const tipoPedidoSelect = document.getElementById('tipo_pedido');
  const costoEntregaSelect = document.querySelector('select[name="id_costo_entrega"]');
  const referenciaSelect = document.querySelector('select[name="id_referencia"]');
  const repartidorSelect = document.getElementById('repartidor');
  const repartidorRequired = document.getElementById('repartidor_required');
  const costoEntregaContainer = document.querySelector('[data-field="costo_entrega"]');
  const referenciaContainer = document.querySelector('[data-field="referencia"]');
  const repartidorContainer = document.querySelector('[data-field="repartidor"]');
  const fechaEntregaInput = document.querySelector('input[name="fecha_entrega"]');
  const fechaEntregaContainer = document.querySelector('[data-field="fecha_entrega"]');
  const horaEntregaInput = document.querySelector('input[name="hora_entrega"]');
  const horaEntregaContainer = document.querySelector('[data-field="hora_entrega"]');
  const ivaRateInput = document.getElementById('iva-rate');
  const ivaRate = ivaRateInput ? parseFloat(ivaRateInput.value) : 0;
  const ivaResumenBadge = document.getElementById('iva_resumen');
  const ivaInput = document.getElementById('iva_monto');
  const restauranteHiddenInput = document.getElementById('id_restaurante');
  const selectedMenusData = {{ (menus_seleccionados or []) | tojson | safe }};

  if (selectedMenusData.length > 0 && totalPedidoInput) {
    const subtotal = selectedMenusData.reduce((acc, item) => acc + (parseFloat(item.Precio) || 0), 0);
    totalPedidoInput.value = subtotal.toFixed(2);
    totalPedidoInput.setAttribute('readonly', 'readonly');
  } else if (totalPedidoInput) {
    totalPedidoInput.removeAttribute('readonly');
  }

  if (selectedMenusData.length > 0 && restauranteHiddenInput && !restauranteHiddenInput.value) {
    const primerMenu = selectedMenusData[0];
    if (primerMenu && primerMenu.idRestaurante) {
      restauranteHiddenInput.value = primerMenu.idRestaurante;
    }
  }

  // Funci√≥n para calcular el total a pagar
  function calcularTotal() {
    if (!totalPedidoInput || !costoServicioInput || !totalPagarInput) {
      return;
    }
    const totalPedido = parseFloat(totalPedidoInput.value) || 0;
    const costoServicio = parseFloat(costoServicioInput.value) || 0;
    
    let costoEntrega = 0;
    if (costoEntregaSelect && 
      costoEntregaContainer &&
      costoEntregaContainer.style.display !== 'none' && 
        costoEntregaSelect.selectedIndex > 0) {
      const textoEntrega = costoEntregaSelect.options[costoEntregaSelect.selectedIndex].text;
      const match = textoEntrega.match(/\$?\s*(\d+\.?\d*)/);
      if (match) {
        costoEntrega = parseFloat(match[1]);
      }
    }
    
    const base = totalPedido + costoServicio + costoEntrega;
    const ivaCalculado = base * (isNaN(ivaRate) ? 0 : ivaRate);
    totalPagarInput.value = (base + ivaCalculado).toFixed(2);
    if (ivaResumenBadge) {
      ivaResumenBadge.textContent = ivaCalculado.toFixed(2);
    }
    if (ivaInput) {
      ivaInput.value = ivaCalculado.toFixed(2);
    }
  }

  // Funci√≥n para verificar campos seg√∫n tipo de pedido
  function verificarCamposSegunTipo() {
    if (!tipoPedidoSelect || !tipoPedidoSelect.value) {
      if (fechaEntregaContainer && fechaEntregaInput) {
        fechaEntregaContainer.style.display = 'none';
        fechaEntregaInput.removeAttribute('required');
        fechaEntregaInput.value = '';
      }
      if (horaEntregaContainer && horaEntregaInput) {
        horaEntregaContainer.style.display = 'none';
        horaEntregaInput.removeAttribute('required');
        horaEntregaInput.value = '';
      }
      return;
    }

    const tipoPedidoTexto = tipoPedidoSelect.options[tipoPedidoSelect.selectedIndex].text.toLowerCase();
    const esSinEntrega = tipoPedidoTexto.includes('local') || tipoPedidoTexto.includes('llevar');
    const esProgramado = tipoPedidoTexto.includes('programado');

    if (fechaEntregaContainer && fechaEntregaInput) {
      if (esProgramado) {
        fechaEntregaContainer.style.display = 'block';
        fechaEntregaInput.setAttribute('required', 'required');
      } else {
        fechaEntregaContainer.style.display = 'none';
        fechaEntregaInput.removeAttribute('required');
        fechaEntregaInput.value = '';
      }
    }

    if (horaEntregaContainer && horaEntregaInput) {
      if (esProgramado) {
        horaEntregaContainer.style.display = 'block';
        horaEntregaInput.setAttribute('required', 'required');
      } else {
        horaEntregaContainer.style.display = 'none';
        horaEntregaInput.removeAttribute('required');
        horaEntregaInput.value = '';
      }
    }

    if (esSinEntrega) {
      if (costoEntregaContainer) {
        costoEntregaContainer.style.display = 'none';
        if (costoEntregaSelect) {
          costoEntregaSelect.removeAttribute('required');
          costoEntregaSelect.value = '';
        }
      }

      if (referenciaContainer) {
        referenciaContainer.style.display = 'none';
        if (referenciaSelect) {
          referenciaSelect.value = '';
        }
      }
      
      if (repartidorContainer) {
        repartidorContainer.style.display = 'none';
        if (repartidorSelect) {
          repartidorSelect.removeAttribute('required');
          repartidorSelect.value = '';
        }
        if (repartidorRequired) {
          repartidorRequired.style.display = 'none';
        }
      }
      
      if (costoServicioInput) {
        costoServicioInput.removeAttribute('required');
        costoServicioInput.value = '0.00';
        costoServicioInput.setAttribute('readonly', 'readonly');
      }
      if (costoServicioRequired) {
        costoServicioRequired.style.display = 'none';
      }
      
    } else {
      if (costoEntregaContainer) {
        costoEntregaContainer.style.display = 'block';
        if (costoEntregaSelect) {
          costoEntregaSelect.setAttribute('required', 'required');
        }
      }

      if (referenciaContainer) {
        referenciaContainer.style.display = 'block';
      }
      
      if (repartidorContainer) {
        repartidorContainer.style.display = 'block';
        if (repartidorSelect) {
          repartidorSelect.setAttribute('required', 'required');
        }
        if (repartidorRequired) {
          repartidorRequired.style.display = 'inline';
        }
      }
      
      if (costoServicioInput) {
        costoServicioInput.setAttribute('required', 'required');
        costoServicioInput.removeAttribute('readonly');
      }
      if (costoServicioRequired) {
        costoServicioRequired.style.display = 'inline';
      }
      
      if (costoEntregaSelect && (!costoEntregaSelect.value || costoEntregaSelect.value === "")) {
        for (let i = 1; i < costoEntregaSelect.options.length; i++) {
          costoEntregaSelect.selectedIndex = i;
          break;
        }
      }
      
      if (costoEntregaSelect && !esSinEntrega && costoEntregaSelect.selectedIndex > 0) {
        const descripcionEntrega = costoEntregaSelect.options[costoEntregaSelect.selectedIndex].text;
        const match = descripcionEntrega.match(/\$?\s*(\d+\.?\d*)/);
        if (match) {
          const precioEntrega = parseFloat(match[1]);
          if (precioEntrega > 0) {
            if (costoServicioInput) {
              costoServicioInput.value = precioEntrega.toFixed(2);
              costoServicioInput.style.backgroundColor = '#d4edda';
              setTimeout(() => {
                costoServicioInput.style.backgroundColor = '';
              }, 500);
            }
          }
        }
      }
    }
    
    calcularTotal();
  }

  // üî• EVENTO: Cuando se selecciona un men√∫
  if (menuSelect) {
    menuSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const precio = selectedOption.getAttribute('data-precio');
      const restaurante = selectedOption.getAttribute('data-restaurante');

      if (restauranteHiddenInput) {
        restauranteHiddenInput.value = restaurante || '';
      }
      
      // 1Ô∏è‚É£ Autocompletar PRECIO
      if (precio && totalPedidoInput) {
        totalPedidoInput.value = parseFloat(precio).toFixed(2);
        totalPedidoInput.style.backgroundColor = '#d4edda';
        setTimeout(() => {
          totalPedidoInput.style.backgroundColor = '';
        }, 500);
      }
      
      calcularTotal();
    });
  }

  // Cuando se cambia el costo de entrega
  if (costoEntregaSelect) {
    costoEntregaSelect.addEventListener('change', function() {
      if (!tipoPedidoSelect || tipoPedidoSelect.selectedIndex < 0) {
        return;
      }
      const tipoPedidoTexto = tipoPedidoSelect.options[tipoPedidoSelect.selectedIndex].text.toLowerCase();
      const esSinEntrega = tipoPedidoTexto.includes('local') || tipoPedidoTexto.includes('llevar');

      if (!esSinEntrega) {
        const descripcionEntrega = this.options[this.selectedIndex].text;
        const match = descripcionEntrega.match(/\$?\s*(\d+\.?\d*)/);
        
        if (match && costoServicioInput) {
          const precioEntrega = parseFloat(match[1]);
          costoServicioInput.value = precioEntrega.toFixed(2);
          costoServicioInput.style.backgroundColor = '#d4edda';
          setTimeout(() => {
            costoServicioInput.style.backgroundColor = '';
          }, 500);
          calcularTotal();
        }
      }
    });
  }

  // Event listeners
  if (totalPedidoInput) {
    totalPedidoInput.addEventListener('input', calcularTotal);
  }
  if (costoServicioInput) {
    costoServicioInput.addEventListener('input', calcularTotal);
  }
  if (tipoPedidoSelect) {
    tipoPedidoSelect.addEventListener('change', verificarCamposSegunTipo);
  }

  // Actualizar color del estado
  function actualizarColorEstado() {
    const select = document.getElementById("estado-select");
    if (!select) return;
    
    select.classList.remove(
      "select-estado-pendiente",
      "select-estado-preparacion",
      "select-estado-camino",
      "select-estado-entregado",
      "select-estado-cancelado"
    );

    const opcion = select.options[select.selectedIndex].className.trim();
    if (opcion !== "") {
      select.classList.add("select-" + opcion);
    }
  }

  const estadoSelect = document.getElementById("estado-select");
  if (estadoSelect) {
    estadoSelect.addEventListener("change", actualizarColorEstado);
    actualizarColorEstado();
  }

  // Autocompletar cliente
  const nombreClienteInput = document.querySelector('input[name="nombre_cliente"]');
  if (nombreClienteInput) {
    nombreClienteInput.addEventListener('input', function(e) {
      const valor = e.target.value;
      const opciones = document.querySelectorAll('#clientes option');
      
      opciones.forEach(function(option) {
        if (option.value === valor) {
          const id = option.getAttribute('data-id');
          const hidden = document.getElementById('id_cliente_hidden');
          if (hidden) {
            hidden.value = id;
          }
        }
      });
    });
  }

  // ‚úÖ INICIALIZAR AL CARGAR
  calcularTotal();
  verificarCamposSegunTipo();
  
  // üî• SI HAY MEN√ö PRESELECCIONADO, AUTOCOMPLETAR TODO
  if (menuSelect && menuSelect.value) {
    // Peque√±o delay para asegurar que todos los elementos est√©n listos
    setTimeout(() => {
      menuSelect.dispatchEvent(new Event('change'));
    }, 100);
  }
});
</script>


{% endblock %}